{% extends "main.html" %}
{% load static %}

{% block extra_js %}
    <script src="{% static 'js/builder/question_detail_variable_quickcreate.js' %}"></script>
{% endblock %}


{% block content %}
  <div class="container my-4">

    <!-- Fragetext -->
    <header class="mb-3">
      <h1 class="h4">{{ question.questiontext }}</h1>
    </header>

    <!-- Konstrukt -->
    {% if question.construct %}
      <div class="small text-secondary mb-3">
        <i class="fa-solid fa-diagram-project me-1"></i>
        {{ question.construct.level_1 }}
        {% if question.construct.level_2 %}
          → {{ question.construct.level_2 }}
        {% endif %}
      </div>
    {% endif %}

    {% if perms.accounts.can_edit_slc %}
      <div class="d-flex justify-content-end mb-3">
        
        <a class="btn btn-outline-secondary btn-sm"
          href="{% url 'questions:question_variables' question.id %}?back={{ request.get_full_path|urlencode }}{% if active_wave %}&wave={{ active_wave.id }}{% endif %}">
          Variablen zuordnen
        </a>
          {% if active_wave %}
          <a class="btn btn-primary btn-sm"
            href="{% url 'questions:question_edit' question.id %}?page={{ page.id }}&wave={{ active_wave.id }}">
            <i class="fa-solid fa-pen-to-square me-1"></i>
            Bearbeiten
          </a>
        {% else %}
          <button class="btn btn-primary btn-sm" disabled
                  title="Bearbeiten ist nur möglich, wenn die Frage in der ausgewählten Welle einer Seite zugeordnet ist.">
            <i class="fa-solid fa-pen-to-square me-1"></i>
            Bearbeiten
          </button>
        {% endif %}
      </div>
    {% endif %}

    <!-- Wellen-Pills -->
    {% if waves %}
      <ul class="nav nav-pills gap-1 flex-nowrap overflow-auto mb-3 small" style="white-space: nowrap;">
        {% for w in waves %}
          <li class="nav-item">
            {% if active_wave and w.id == active_wave.id %}
              <a href="{% url 'questions:question_detail' question.id %}?wave={{ w.id }}"
                class="nav-link rounded-pill py-1 px-2 bg-primary text-white"
                aria-current="page">
                {{ w }}
              </a>
            {% else %}
              <a href="{% url 'questions:question_detail' question.id %}?wave={{ w.id }}"
                class="nav-link rounded-pill py-1 px-2 bg-secondary-subtle text-secondary-emphasis border">
                {{ w }}
              </a>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

    {% endif %}

    <!-- Variablenliste -->
    <div class="accordion mb-3" id="variablenAccordion-{{ question.id }}">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingVariablen-{{ question.id }}">
          <button class="accordion-button" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseVariablen-{{ question.id }}"
                  aria-expanded="true"
                  aria-controls="collapseVariablen-{{ question.id }}">
            Variablen {% if active_wave %}in {{ active_wave.name|default:active_wave }}{% endif %}
          </button>
        </h2>

        <div id="collapseVariablen-{{ question.id }}"
            class="accordion-collapse collapse show"
            aria-labelledby="headingVariablen-{{ question.id }}"
            data-bs-parent="#variablenAccordion-{{ question.id }}">
          <div class="accordion-body p-0">

            {% if variables %}
              <div class="list-group list-group-flush">
                {% for v in variables %}
                  <a class="list-group-item list-group-item-action"
                    href="{% url 'variables:variable_detail' v.id %}">
                    <div class="fw-semibold">{{ v.varname }}</div>
                    {% if v.varlab %}
                      <div class="text-muted small text-truncate">{{ v.varlab }}</div>
                    {% endif %}
                  </a>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted px-3 py-2 mb-0">Für diese Befragung/Gruppe sind keine Variablen verknüpft.</p>
            {% endif %}

          </div>
        </div>
      </div>
    </div>

    {% if perms.accounts.can_edit_slc %}
      <div class="mb-4">
        <button type="button"
                class="btn btn-outline-success"
                data-bs-toggle="modal"
                data-bs-target="#qcVarForQuestionModal">
          <i class="fa-solid fa-plus"></i> Neue Variable
        </button>
      </div>
    {% endif %}



    <!-- Seiten -->
    <div class="accordion mb-3" id="pageAccordion-{{ question.id }}">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingPage-{{ question.id }}">
          <button class="accordion-button" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapsePage-{{ question.id }}"
                  aria-expanded="true"
                  aria-controls="collapsePage-{{ question.id }}">
            Fragebogenseite in {{ active_wave.name|default:active_wave }}
          </button>
        </h2>

        <div id="collapsePage-{{ question.id }}"
            class="accordion-collapse collapse show"
            aria-labelledby="headingPage-{{ question.id }}"
            data-bs-parent="#pageAccordion-{{ question.id }}">
          <div class="accordion-body p-0">

            {% if page %}
              <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action"
                  href="{% url 'pages:page-detail' page.id %}?wave={{ active_wave.id }}">
                  <div class="fw-semibold">
                    Seite: {{ page.pagename }}
                  </div>
                </a>
              </div>
            {% else %}
              <p class="text-muted px-3 py-2 mb-0">Für diese Frage ist hier noch keine Seite verknüpft.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    
    {% if screenshots %}
      <h2 class="h6 mb-2 fw-semibold">Screenshots</h2>

      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        {% for s in screenshots %}
          <div class="col">
            <div class="card shadow-sm">

              <a href="/{{ s.image_path }}"
                class="glightbox"
                data-gallery="question-{{ question.id }}"
                data-title="Sprache: {{ s.language }} | Ansicht: {{ s.device }}{% if page %} | Seite: {{ page.pagename }}{% endif %}">

                <img
                  src="/{{ s.image_path }}"
                  class="card-img-top"
                  alt="Screenshot {{ forloop.counter }}"
                  style="cursor: zoom-in;"
                  onerror='
                    this.onerror = null;
                    this.outerHTML = "<div class=\"d-flex align-items-center justify-content-center bg-light text-muted border\" style=\"height:200px; font-size:0.9rem;\">Screenshot konnte nicht geladen werden</div>";'
                >
              </a>

              <div class="card-body small">
                <div><strong>Sprache:</strong> {{ s.language }}</div>
                <div><strong>Ansicht:</strong> {{ s.device }}</div>
              </div>

            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

  </div>

  <!-- Modal: Variable-Schnellerstellung für Question -->
  <div class="modal fade"
     id="qcVarForQuestionModal"
     data-varname-check-url="{% url 'variables:variable_varname_check' %}"
     data-create-url="{% url 'variables:variable_quickcreate_question' %}"
     data-question-id="{{ question.id }}"
     tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Neue Variable anlegen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Variablenname</label>
            <input type="text" class="form-control" id="qcq-varname" autocomplete="off">
            <div class="form-text">Mindestens 2 Zeichen.</div>
          </div>

          <div class="mt-2" id="qcq-name-status"></div>
          <div class="mt-2 d-none" id="qcq-suggestions"></div>

          <hr class="my-3">

          <label class="form-label">Befragungsgruppen</label>
          <div class="d-flex flex-wrap gap-2" id="qcq-waves">
            {% for w in waves %}
              <div class="form-check form-check-inline">
                <input class="form-check-input"
                      type="checkbox"
                      name="wave_ids"
                      value="{{ w.id }}"
                      id="qcq-wave-{{ w.id }}"
                      {% if w.is_locked %}disabled{% endif %}
                      {% if active_wave and w.id == active_wave.id %}checked{% endif %}>
                <label class="form-check-label" for="qcq-wave-{{ w.id }}">
                  {{ w.cycle }} {{ w.instrument }}
                  {% if w.is_locked %}<span class="text-muted">(locked)</span>{% endif %}
                </label>
              </div>
            {% endfor %}
          </div>

          <div class="alert alert-danger d-none mt-3 mb-0" id="qcq-error"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
          <button type="button" class="btn btn-outline-primary" id="qcq-later">Später vervollständigen</button>
          <button type="button" class="btn btn-primary" id="qcq-complete">Angaben vervollständigen</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

