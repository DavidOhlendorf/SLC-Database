{# pages/page_form.html #}

{% extends "main.html" %}
{% load static %}

{% block extra_js %}
    <script src="{% static 'js/builder/page_question_formset.js' %}"></script>
    <script src="{% static 'js/ui/tooltips.js' %}"></script>
    <script src="{% static 'js/ui/accordion_auto_open.js' %}"></script>
    <script src="{% static 'js/ui/required_badge.js' %}"></script>
    <script src="{% static 'js/builder/page_question_create.js' %}"></script>
{% endblock %}

{% block content %}
    <h1 class="mb-0">Fragebogenseite bearbeiten</h1>

    <div class="mt-3" style="max-width: 980px;">
        <div class="mb-3 d-flex align-items-start justify-content-between gap-2">
            <div>
                {% if survey and active_wave %}
                <a href="{% url 'waves:survey_detail' survey.name %}?wave={{ active_wave.id }}"
                    class="text-muted small text-decoration-none opacity-75">
                    ← Alle Seiten dieses Fragebogens anzeigen
                </a>
                {% endif %}
            </div>

            <div>
                <a href="{% url 'pages:page-detail' page.id %}{% if request.GET.wave %}?wave={{ request.GET.wave }}{% endif %}"
                    class="text-muted small text-decoration-none opacity-75">
                    Zur Seitenansicht →
                </a>
            </div>
        </div>

    
       <!--- Basisdaten der Seite--->
        <div class="card shadow-sm mb-4" id="base">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">Seitenname und Befragtengruppen</h5>

                    <div class="d-flex align-items-center gap-1">
                        <button
                            type="button"
                            class="btn btn-link px-2 icon-action"
                            form="base-form"
                            id="base-edit-btn"
                            title="Bearbeiten">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <button 
                            type="submit"
                            class="btn btn-link px-2 icon-action--success d-none"
                            form="base-form"
                            id="base-save-btn"
                            title="Speichern">
                            <i class="fa-solid fa-check"></i>
                        </button>

                        <button
                            type="button"
                            class="btn btn-link px-2 icon-action--danger d-none"
                            form="base-form"
                            id="base-cancel-btn"
                            title="Änderungen verwerfen">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>

                {% url "pages:page-edit-base" page.id as base_action %}
                <form
                    method="post"
                    action="{{ base_action }}{% if request.GET.wave %}?wave={{ request.GET.wave }}{% endif %}"
                    id="base-form">

                    {% csrf_token %}

                    {% if base_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ base_form.non_field_errors|striptags }}
                        </div>
                    {% endif %}

                    <div class="row g-3" id="base-fields">
                        <div class="col-md-7">
                            <div class="form-floating">
                                {{ base_form.pagename }}
                                <label for="{{ base_form.pagename.id_for_label }}">Seitenname (pn)</label>
                            </div>

                            {% if base_form.pagename.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ base_form.pagename.errors|striptags }}
                                </div>
                            {% endif %}

                            {% if base_form.pagename.help_text %}
                                <div class="form-text">{{ base_form.pagename.help_text }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-5">
                            <div class="fw-semibold mb-1">Befragtengruppen</div>

                            {% if base_form.waves.errors %}
                                <div class="invalid-feedback d-block mb-2">
                                    {{ base_form.waves.errors|striptags }}
                                </div>
                            {% endif %}

                            <div class="vstack gap-1">
                                {% for cb in base_form.waves %}
                                    <label class="form-check">
                                        {{ cb.tag }}
                                        <span class="form-check-label">{{ cb.choice_label }}</span>
                                    </label>
                                {% endfor %}
                            </div>

                            {% if base_form.waves.help_text %}
                                <div class="form-text">{{ base_form.waves.help_text }}</div>
                            {% endif %}
                        </div>

                    </div>
                </form>
            </div>
        </div>



        <!--- Inhaltsdaten der Seite--->
        {% url "pages:page-edit-content" page.id as content_action %}
        <form method="post"
            action="{{ content_action }}{% if request.GET.wave %}?wave={{ request.GET.wave }}{% endif %}"
            id="content-form">

            {% csrf_token %}

            {% if content_form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ content_form.non_field_errors|striptags }}
                </div>
            {% endif %}

            <!-- Zusatzfelder 1 -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Seitenkopf</h5>

                    <div class="accordion" id="accordionPageHeader">

                        <!-- Überschrift auf der Seite (hl) -->
                        <div class="accordion-item" data-acc-open-when-filled="page_heading">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-hl">
                                    Überschrift auf der Seite (hl)
                                </button>
                            </h2>
                            <div id="col-hl"
                                class="accordion-collapse collapse {% if content_form.page_heading.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.page_heading }}
                                </div>
                            </div>
                        </div>

                        <!-- Einleitung auf der Seite (in) -->
                        <div class="accordion-item" data-acc-open-when-filled="introduction">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-in">
                                    Einleitung auf der Seite (in)
                                </button>
                            </h2>
                            <div id="col-in"
                                class="accordion-collapse collapse {% if content_form.introduction.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.introduction }}
                                </div>
                            </div>
                        </div>

                        <!-- Transitionskontrolle (tc) -->
                        <div class="accordion-item" data-acc-open-when-filled="transition_control" data-required-field="transition_control">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-tc">
                                    Transitionskontrolle (tc)
                                    <span data-required-badge class="ms-2"></span>
                                </button>
                            </h2>
                            <div id="col-tc"
                                class="accordion-collapse collapse {% if content_form.transition_control.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.transition_control }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Fragen auf dieser Seite -->
            <div class="card shadow-sm mb-4" id="questions">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <h5 class="card-title mb-3">Fragen auf dieser Seite</h5>

                        <button type="button"
                            class="btn btn-sm"
                            data-bs-toggle="tooltip"
                            data-bs-placement="left"
                            title="Hier kannst du bestimmen, welche Fragen auf dieser Seite erscheinen sollen. Du kannst neue Fragen erstellen oder bestehende Fragen auswählen.
                            Wenn die Seite für mehrere Gruppen sichtbar ist, kannst du festlegen, welche Gruppen eine Frage sehen sollen.">
                            <i class="fa-solid fa-circle-info"></i>
                        </button>
                    </div>

                    {% if question_formset.non_form_errors %}
                        <div class="alert alert-danger">
                            {{ question_formset.non_form_errors|striptags }}
                        </div>
                    {% endif %}

                    <!-- Verstecktes Feld, um JS mitzuteilen, ob es Fehler im Formset gibt -->
                    {% if question_formset.errors or question_formset.non_form_errors %}
                        <input type="hidden" id="qfs-has-errors" value="1">
                    {% endif %}

                    {{ question_formset.management_form }}

                    <div id="qfs-container" class="vstack gap-3" data-formset-prefix="qfs">
                        {% for qf in question_formset.forms %}
                            <div class="border rounded p-3 qfs-form {% if qf.errors %}border-danger{% endif %}">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-6">
                                        <label class="form-label">Frage</label>
                                        <div class="input-group">
                                        {{ qf.question }}
                                        <button type="button" class="btn btn-outline-secondary qc-search" title="Frage suchen" disabled>
                                            <i class="fa-solid fa-magnifying-glass"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-success qc-open" title="Neue Frage anlegen">
                                            <i class="fa-solid fa-plus"></i>
                                            <span class="d-none d-lg-inline ms-1">Neu</span>
                                        </button>
                                        </div>

                                        {% if qf.question.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ qf.question.errors|striptags }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-5">
                                        <label class="form-label">Befragtengruppe(n)</label>
                                        <div class="vstack gap-1">
                                            {% for cb in qf.waves %}
                                                <label class="form-check">
                                                    {{ cb.tag }}
                                                    <span class="form-check-label">{{ cb.choice_label }}</span>
                                                </label>
                                            {% endfor %}
                                        </div>
                                        {% if qf.waves.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ qf.waves.errors|striptags }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-1 text-end">
                                        {% if qf.DELETE %}
                                            <div class="d-none">{{ qf.DELETE }}</div>
                                        {% endif %}
                                        <button type="button"
                                                class="btn btn-outline-danger btn-sm qfs-remove"
                                                title="Frage entfernen">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="qfs-add">
                            + Frage hinzufügen
                        </button>
                    </div>

                    <template id="qfs-empty-form-template">
                        <div class="border rounded p-3 qfs-form">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label">Frage</label>
                                    <div class="d-flex gap-2 align-items-start">
                                        <div class="flex-grow-1">
                                            {{ question_formset.empty_form.question }}
                                        </div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm qc-open">
                                            + Neu
                                        </button>

                                    <button type="button"
                                            class="btn btn-outline-danger btn-sm qfs-remove"
                                            title="Frage entfernen">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>


                                    </div>
                                </div>

                                <div class="col-md-5">
                                    <label class="form-label">Befragtengruppe(n)</label>
                                    <div class="vstack gap-1">
                                        {% for cb in question_formset.empty_form.waves %}
                                            <label class="form-check">
                                                {{ cb.tag }}
                                                <span class="form-check-label">{{ cb.choice_label }}</span>
                                            </label>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-md-1 text-end">
                                    {% if question_formset.empty_form.DELETE %}
                                        <div class="d-none">{{ question_formset.empty_form.DELETE }}</div>
                                    {% endif %}
                                    <button type="button"
                                            class="btn btn-outline-danger btn-sm qfs-remove"
                                            title="Frage entfernen">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Zusatzfelder 2 -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Seitenübergänge</h5>

                    <div class="accordion" id="accordionPageLogic">

                        <!-- Filter (tr) -->
                        <div class="accordion-item" data-acc-open-when-filled="transitions" data-required-field="transitions">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-tr">
                                    Filter / Transitions (tr)
                                    <span data-required-badge class="ms-2"></span>
                                </button>
                            </h2>
                            <div id="col-tr"
                                class="accordion-collapse collapse {% if content_form.transitions.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.transitions }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Zusatzfelder 3 -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Sonstige Seitenangaben</h5>

                    <div class="accordion" id="accordionAdditionalPageFields">

                        <!-- visibility conditions (vc)-->
                        <div class="accordion-item" data-acc-open-when-filled="visibility_conditions">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-vc">
                                    Einblendbedingungen (vc)
                                </button>
                            </h2>
                            <div id="col-vc"
                                class="accordion-collapse collapse {% if content_form.visibility_conditions.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.visibility_conditions }}
                                </div>
                            </div>
                        </div>

                        <!-- Antwortvalidierung (av) -->
                        <div class="accordion-item" data-acc-open-when-filled="answer_validations">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-av">
                                    Antwortvalidierungen (av)
                                </button>
                            </h2>
                            <div id="col-av"
                                class="accordion-collapse collapse {% if content_form.answer_validations.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.answer_validations }}
                                </div>
                            </div>
                        </div>

                        <!-- Korrekturhinweis (kh) -->
                        <div class="accordion-item" data-acc-open-when-filled="correction_note">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-kh">
                                    Korrekturhinweise (kh)
                                </button>
                            </h2>
                            <div id="col-kh"
                                class="accordion-collapse collapse {% if content_form.correction_note.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.correction_note }}
                                </div>
                            </div>
                        </div>

                        <!-- Forcierungsvariablen (fv) -->
                        <div class="accordion-item" data-acc-open-when-filled="forcing_variables">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-fv">
                                    Forcierungsvariablen (fv)
                                </button>
                            </h2>
                            <div id="col-fv"
                                class="accordion-collapse collapse {% if content_form.forcing_variables.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.forcing_variables }}
                                </div>
                            </div>
                        </div>

                        <!-- Hilfsvariablen (hv) -->
                        <div class="accordion-item" data-acc-open-when-filled="helper_variables">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-hv">
                                    Hilfsvariablen (hv)
                                </button>
                            </h2>
                            <div id="col-hv"
                                class="accordion-collapse collapse {% if content_form.helper_variables.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.helper_variables }}
                                </div>
                            </div>
                        </div>

                        <!-- Steuerungsvariablen (sv) -->
                        <div class="accordion-item" data-acc-open-when-filled="control_variables">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-sv">
                                    Steuerungsvariablen (sv)
                                </button>
                            </h2>
                            <div id="col-sv"
                                class="accordion-collapse collapse {% if content_form.control_variables.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.control_variables }}
                                </div>
                            </div>
                        </div>

                        <!-- Formatierung (fo) -->
                        <div class="accordion-item" data-acc-open-when-filled="form">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-fo">
                                    Formatierungen (fo)
                                </button>
                            </h2>
                            <div id="col-fo"
                                class="accordion-collapse collapse {% if content_form.formatting.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.formatting }}
                                </div>
                            </div>
                        </div>

                        <!-- Programmierhinweise (hi) -->
                        <div class="accordion-item" data-acc-open-when-filled="page_programming_notes">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#col-hi">
                                    Programmierhinweise (hi)
                                </button>
                            </h2>
                            <div id="col-hi"
                                class="accordion-collapse collapse {% if content_form.page_programming_notes.errors %}show{% endif %}">
                                <div class="accordion-body">
                                    {{ content_form.page_programming_notes }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons für das Formular -->
            <div class="d-flex justify-content-between align-items-center gap-2">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-dark">Inhalte speichern</button>
                    <a class="btn btn-outline-secondary"
                    href="{% url 'pages:page-detail' page.id %}{% if request.GET.wave %}?wave={{ request.GET.wave }}{% endif %}">
                    Abbrechen
                    </a>
                </div>

                <div>
                    {% if delete_blocked %}
                    <span
                        class="d-inline-block"
                        tabindex="0"
                        data-bs-toggle="tooltip"
                        data-bs-title="Diese Seite kann nicht gelöscht werden, weil sie mit einer abgeschlossenen Befragung verknüpft ist.">
                        <button type="button" class="btn btn-outline-danger" disabled>
                            <i class="fa-solid fa-trash me-1"></i> Seite löschen
                        </button>
                    </span>
                    {% else %}
                    <button
                        type="button"
                        class="btn btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deletePageModal">
                        <i class="fa-solid fa-trash me-1"></i> Seite löschen
                    </button>
                    {% endif %}
                </div>
            </div>

        </form>
    </div>
    
    <!-- Modal zum Löschen der Seite -->
    {% url "pages:page-delete" page.id as delete_action %}
    <div class="modal fade" id="deletePageModal" tabindex="-1" aria-labelledby="deletePageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="deletePageModalLabel">Seite löschen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>

            <div class="modal-body">
                <p class="mb-2">
                    Soll die Seite <strong>{{ page.pagename }}</strong> wirklich gelöscht werden?
                </p>
                <p class="text-muted small mb-0">
                    Dadurch wird die Seite für alle Befragungsgruppen gelöscht.
                    Wenn die Seite nur für einzelne Gruppen dieser Befragung nicht genutzt werden soll, kannst du das in der Bearbeitungspübersicht der Seite anpassen.
                </p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Abbrechen
                </button>

                <form
                    method="post"
                    action="{{ delete_action }}{% if request.GET.wave %}?wave={{ request.GET.wave }}{% endif %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        Löschen
                    </button>
                </form>
            </div>

            </div>
        </div>
    </div>

    <!-- Modal: Frage Quickcreate -->
    {% url "questions:question-quick-create-for-page-ajax" page.id as qc_post_url %}
    {% include "pages/_question_quickcreate_modal.html" with qc_mode="ajax" qc_post_url=qc_post_url %}



{% endblock %}
