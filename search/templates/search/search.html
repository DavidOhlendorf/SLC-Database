{% extends 'main.html' %}
{% load querystring %}

{% block content %}
  <form action="{% url 'search' %}" method="get" class="mb-3">
    <div class="row">
      <div class="col-md-6 col-lg-4">
        <div class="input-group">
          <input type="search" class="form-control rounded-start-pill" name="q" value="{{ q }}" placeholder="Suche…">
          <button class="btn btn-dark rounded-end-pill px-4 ms-1">Suchen</button>
        </div>
      </div>
    </div>

    <input type="hidden" name="type" value="{{ type }}">
    <input type="hidden" name="sort" value="{{ sort }}">
    {% for id in selected_wave_ids %}
      <input type="hidden" name="waves" value="{{ id }}">
    {% endfor %}

  </form>

  <ul class="nav nav-tabs my-3" role="tablist">
    {% for t,label in tabs %}
      <li class="nav-item" role="presentation">
        <a
          class="nav-link {% if type == t %}active{% endif %}"
          href="{% url 'search' %}{% url_with type=t page=None waves=selected_wave_ids%}"
          aria-current="{% if type == t %}page{% else %}false{% endif %}">
          {{ label }}
        </a>
      </li>
    {% endfor %}
  </ul>

  
  <form method="get" id="filter-form" class="mb-3">
    {# bestehende Suchparameter #}
    <input type="hidden" name="q" value="{{ q }}">
    <input type="hidden" name="type" value="{{ type }}">
    <input type="hidden" name="sort" value="{{ sort }}">

    <div class="d-flex align-items-center gap-2 mb-2">
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          Sortierung: {% if sort == "alpha" %}Alphabetisch{% else %}Relevanz{% endif %}
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item {% if sort == 'relevance' %}active{% endif %}"
              href="{% url 'search' %}{% url_with sort='relevance' page=None waves=selected_wave_ids %}">
              Relevanz
            </a>
          </li>
          <li>
            <a class="dropdown-item {% if sort == 'alpha' %}active{% endif %}"
              href="{% url 'search' %}{% url_with sort='alpha' page=None waves=selected_wave_ids %}">
              Alphabetisch (A–Z)
            </a>
          </li>
        </ul>
      </div>
      <button type="button" id="btn-open-wave-panel" class="btn btn-outline-secondary">
        Filter
      </button>
    </div>


    <div class="d-flex flex-wrap gap-2">
        {% if selected_waves %}
          {% for w in selected_waves %}
            <span class="badge rounded-pill text-bg-primary d-inline-flex align-items-center">
              {{ w }}
              <button type="button"
                      class="btn btn-sm btn-link ms-1 text-white text-decoration-none remove-chip"
                      data-wave-id="{{ w.id }}"
                      aria-label="Filter {{ w }} entfernen">×</button>
            </span>
          {% endfor %}
        {% endif %}

    </div>

    {# versteckte Checkboxen tragen die waves[]= IDs #}
    <div class="visually-hidden">
      {% for w in all_waves %}
        <input type="checkbox"
              name="waves"
              value="{{ w.id }}"
              id="wave-{{ w.id }}"
              {% if w.id in selected_wave_ids %}checked{% endif %}>
      {% endfor %}
    </div>

    {# Panel zum Auswählen #}
    <div id="wave-panel" class="card mt-2" style="display:none; max-width: 680px;">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong>SLC Cycle</strong>
          <button type="button" class="btn-close" id="btn-close-wave-panel" aria-label="Schließen"></button>
        </div>

        <div id="wave-list" style="max-height: 260px; overflow:auto;">
          {% if facet_waves %}
            <ul id="facet-list" class="list-unstyled mb-0">
              {% for item in facet_waves %}
                <li class="wave-item" data-label="{{ item.wave|stringformat:'s'|lower }}">
                  <div class="form-check">
                    <input
                      class="form-check-input wave-check"
                      type="checkbox"
                      name="waves"
                      id="wave-panel-{{ item.wave.id }}"
                      value="{{ item.wave.id }}"
                      {% if item.selected %}checked{% endif %}
                    >
                    <label class="form-check-label d-flex justify-content-between align-items-center" for="wave-panel-{{ item.wave.id }}">
                      <span>{{ item.wave }}</span>
                      <span class="badge text-bg-light">{{ item.count }}</span>
                    </label>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted mb-0">Keine Cycle auswählbar.</p>
          {% endif %}
        
          <ul id="all-list" class="list-unstyled mb-0" style="display:none;">
            {% for item in all_waves_facets %}
              <li class="wave-item">
                <div class="form-check d-flex justify-content-between align-items-center">
                  <div>
                    <input class="form-check-input wave-check"
                          type="checkbox"
                          name="waves"
                          id="wave-panel-all-{{ item.wave.id }}"
                          value="{{ item.wave.id }}"
                          {% if item.selected %}checked{% endif %}>
                    <label class="form-check-label" for="wave-panel-all-{{ item.wave.id }}">
                      {{ item.wave }}
                    </label>
                  </div>
                  <span class="badge text-bg-light">{{ item.count }}</span>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div> 

        <div class="d-flex justify-content-end gap-2 mt-3">
           <button type="button" id="btn-show-all-waves" class="btn btn-outline-secondary">Alle anzeigen</button>
          <button type="button" id="btn-clear-waves" class="btn btn-outline-secondary">Zurücksetzen</button>
          <button type="submit" class="btn btn-primary">Übernehmen</button>
        </div>
      </div>
    </div>
  </form>
 

  {% if type == "all" %}
    {% if questions or variables or constructs %}
      {% if questions %}
        <section>
          <h2>Fragen ({{ questions_count }} Treffer)</h2>
          {% if questions %}
            {% for item in questions %}
              {% include "search/_card_question.html" with item=item %}
            {% endfor %}
            <p>
              <a href="{% url 'search' %}{% url_with type='questions' page=None waves=selected_wave_ids%}">Mehr anzeigen</a>
            </p>
          {% else %}
            <p class="muted">Keine Fragen gefunden.</p>
          {% endif %}
        </section>
      {% endif %}

      {% if variables %}
        <section>
          <h2>Variablen ({{ variables_count }} Treffer)</h2>
          {% if variables %}
            {% for item in variables %}
              {% include "search/_card_variable.html" with item=item %}
            {% endfor %}
            <p>
              <a href="{% url 'search' %}{% url_with type='variables' page=None  waves=selected_wave_ids%}">Mehr anzeigen</a>
            </p>
          {% else %}
            <p class="muted">Keine Variablen gefunden.</p>
          {% endif %}
        </section>
      {% endif %}

      {% if constructs %}
        <section>
          <h2>Konstrukte ({{ constructs_count }} Treffer)</h2>
          {% if constructs %}
            {% for item in constructs %}
              {% include "search/_card_construct.html" with item=item %}
            {% endfor %}
            <p>
              <a href="{% url 'search' %}{% url_with type='constructs' page=None  waves=selected_wave_ids%}">Mehr anzeigen</a>
            </p>
          {% else %}
            <p class="muted">Keine Konstrukte gefunden.</p>
          {% endif %}
        </section>
      {% endif %}

    {% else %}
    <p class="muted">Keine Treffer gefunden.</p>
    {% endif %}
  {% endif %}


  {% if type == "questions" %}
    <h2>Fragen ({{ questions_count }} Treffer)</h2>

    {% if questions %}

      {% for item in questions %}
        {% include "search/_card_question.html" with item=item %}
      {% endfor %}

      {% if questions_page and questions_page.paginator.num_pages > 1 %}
        {% include "search/_pagination.html" with page_obj=questions_page type="questions" %}
      {% endif %}

    {% else %}
      <p class="muted">Keine Fragen gefunden.</p>
    {% endif %}

  {% endif %}

  {% if type == "variables" %}
  <h2>Variablen ({{ variables_count }} Treffer)</h2>

    {% if variables %}
      {% for item in variables %}
        {% include "search/_card_variable.html" with item=item %}
      {% endfor %}

      {% if variables_page and variables_page.paginator.num_pages > 1 %}
        {% include "search/_pagination.html" with page_obj=variables_page type="variables" %}
      {% endif %}

    {% else %}
      <p class="muted">Keine Variablen gefunden.</p>
    {% endif %}

  {% endif %}

  {% if type == "constructs" %}
    <h2>Konstrukte ({{ constructs_count }} Treffer)</h2>

    {% if constructs %}
      {% for item in constructs %}
        {% include "search/_card_construct.html" with item=item %}
      {% endfor %}

      {% if constructs_page and constructs_page.paginator.num_pages > 1 %}
        {% include "search/_pagination.html" with page_obj=constructs_page type="constructs" %}
      {% endif %}

    {% else %}
      <p class="muted">Keine Konstrukte gefunden.</p>
    {% endif %}
  {% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  (function () {
    const form     = document.getElementById('filter-form');
    const panel    = document.getElementById('wave-panel');
    const openBtn  = document.getElementById('btn-open-wave-panel');
    const closeBtn = document.getElementById('btn-close-wave-panel');

    const facetList = document.getElementById('facet-list');
    const allList   = document.getElementById('all-list');

    // --- Helper: sichtbare Checkboxen mit versteckten Inputs synchronisieren ---
    function wirePanelChecks() {
      const checks = Array.from(document.querySelectorAll('#wave-list .wave-check'));
      checks.forEach(chk => {
        chk.onchange = () => {
          const hidden = document.getElementById('wave-' + chk.value);
          if (hidden) hidden.checked = chk.checked;
        };
      });
    }
    wirePanelChecks();

    // --- Panel öffnen / schließen ---
    if (openBtn)  openBtn.addEventListener('click', () => { panel.style.display = 'block'; });
    if (closeBtn) closeBtn.addEventListener('click', () => { panel.style.display = 'none';  });

    // --- Zurücksetzen ---
    const resetBtn = document.getElementById('btn-clear-waves');
    if (resetBtn) resetBtn.addEventListener('click', () => {
      document.querySelectorAll('#wave-list .wave-check').forEach(c => c.checked = false);
      document.querySelectorAll('input[type="checkbox"][name="waves"]').forEach(h => h.checked = false);
      form.submit();
    });

    // --- Chips (×) entfernen ---
    document.querySelectorAll('.remove-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.waveId;
        const hidden = document.getElementById('wave-' + id);
        if (hidden) hidden.checked = false;
        document.querySelectorAll('#wave-list .wave-check[value="' + id + '"]').forEach(c => c.checked = false);
        form.submit();
      });
    });

    // --- Umschalten zwischen Treffer / Alle ---
    const btnToggle = document.getElementById('btn-show-all-waves');
    if (btnToggle) btnToggle.addEventListener('click', () => {
      const showingAll = allList && allList.style.display !== 'none';

      if (showingAll) {
        // zurück zu Treffer
        if (allList)   allList.style.display   = 'none';
        if (facetList) facetList.style.display = '';
        btnToggle.textContent = 'Alle anzeigen';
      } else {
        // zu Alle umschalten
        if (facetList) facetList.style.display = 'none';
        if (allList)   allList.style.display   = '';
        btnToggle.textContent = 'Nur Treffer anzeigen';
      }
      wirePanelChecks();
    });
  })();
});
</script>



{% endblock %}

