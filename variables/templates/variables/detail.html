{% extends "main.html" %}

{% load static %}
{% block extra_js %}
      <script src="{% static 'js/ui/tooltips.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Variablenname  etc. -->
  <header>
    <div class="d-flex align-items-start justify-content-between gap-3">
      <div class="flex-grow-1 min-w-0">
        <h1 class="h3 mb-0 text-break">
          Variable: {{ variable.varname }}
          {% if perms.accounts.can_edit_slc and variable.is_incomplete %}
            <span>
              <i class="fa-solid fa-circle-exclamation text-danger"
                data-bs-toggle="tooltip"
                data-bs-title="Frage unvollständig: Pflichtfelder nicht gefüllt oder keine Variablen verknüpft."></i>
            </span>
          {% endif %}
        </h1>
      </div>
      <div class="flex-shrink-0">
        {% if perms.accounts.can_edit_slc %}
            <a class="btn btn-link btn-lg icon-action p-0"
              title="Variable bearbeiten"
              href="{% url 'variables:variable_edit' variable.pk %}?back={{ request.get_full_path|urlencode }}">
              <i class="fa-solid fa-pen-to-square"></i>
            </a>
        {% endif %}
      </div>
    </div>
  </header>


  <!-- Varlabel -->
  <div class="text-secondary mb-2">
    {% if variable.varlab %}
      {{ variable.varlab }}
    {% else %}
      <span class="text-muted">Kein Variablenlabel vergeben.</span>
    {% endif %}

  </div>

  <hr class="my-2 mb-4">

  <!-- Back-Link  -->
  <div class="mb-3">
    <a href="{{ back_url|default:'/' }}"
      class="text-muted small text-decoration-none opacity-75">
      ← Zurück
    </a>
  </div>

  <!-- Fragen der Variablen -->
  <div class="accordion mb-3" id="variablenAccordion-{{ variable.pk }}">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingVariablen-{{ variable.pk }}">
        <button class="accordion-button" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseVariablen-{{ variable.pk }}"
                aria-expanded="true"
                aria-controls="collapseVariablen-{{ variable.pk }}">
          Zugehörige {% if single_question %} Frage {% else %} Fragen {% endif %}
        </button>
      </h2>

      <div id="collapseVariablen-{{ variable.pk }}"
          class="accordion-collapse collapse show"
          aria-labelledby="headingVariablen-{{ variable.pk }}"
          data-bs-parent="#variablenAccordion-{{ variable.pk }}">
        <div class="accordion-body p-0">
          {% if questions %}
            <div class="list-group list-group-flush">
              {% for q in questions %}
                <div class="list-group-item d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2">
                      <span>{{ q.questiontext|truncatechars:160}}</span>
                      {% if perms.accounts.can_edit_slc %}
                        {% if q.is_incomplete %}
                          <span>
                          <i class="fa-solid fa-circle-exclamation text-danger"
                            data-bs-toggle="tooltip"
                            data-bs-title="Fragenangaben unvollständig"></i>
                          </span>
                        {% endif %}
                      {% endif %}
                    </div>
                  </div>
                  <div class="ms-2 btn-group btn-group-sm" role="group" aria-label="Aktionen">
                    <a class="btn btn-link px-2 icon-action"
                      title="Details anzeigen"
                      href="{% url 'questions:question_detail' q.pk %}">
                      <i class="fa-regular fa-eye"></i>
                    </a>
                    {% if perms.accounts.can_edit_slc %}
                      <a class="btn btn-link px-2 icon-action"
                        title="Frage bearbeiten"
                        href="{% url 'questions:question_edit' q.pk %}">
                        <i class="fa-solid fa-pen-to-square"></i>
                      </a>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted px-3 py-2 mb-0">Für diese Befragung/Gruppe sind keine Fragen verknüpft.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>








  <!-- Kontext: Accordion-Card, standardmäßig offen -->
  <div class="accordion mb-3" id="contextAccordion-{{ variable.pk }}">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingContext-{{ variable.pk }}">
        <button class="accordion-button" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseContext-{{ variable.pk }}"
                aria-expanded="true"
                aria-controls="collapseContext-{{ variable.pk }}">
          In folgenden Befragungen eingesetzt:
        </button>
      </h2>

      <div id="collapseContext-{{ variable.pk }}"
           class="accordion-collapse collapse show"
           aria-labelledby="headingContext-{{ variable.pk }}"
           data-bs-parent="#contextAccordion-{{ variable.pk }}">
        <div class="accordion-body">

          <div>
            <strong class="d-block mb-1">Befragungen</strong>
            {% if variable.waves.exists %}
              <div class="d-flex flex-wrap gap-2">
                {% for w in variable.waves.all %}
                  <span class="badge rounded-pill text-bg-light border">{{ w.name|default:w }}</span>
                {% endfor %}
              </div>
            {% else %}
              <span class="text-muted">Keine Befragungen verknüpft.</span>
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>
  
  <!-- Value-Label: 1 Accordion-Card, standardmäßig offen -->
  <div class="accordion mb-3" id="vallabAccordion-{{ variable.pk }}">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingVallab-{{ variable.pk }}">
        <button class="accordion-button" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseVallab-{{ variable.pk }}"
                aria-expanded="true"
                aria-controls="collapseVallab-{{ variable.pk }}">
          Value-Label
        </button>
      </h2>
      <div id="collapseVallab-{{ variable.pk }}"
           class="accordion-collapse collapse show"
           aria-labelledby="headingVallab-{{ variable.pk }}"
           data-bs-parent="#vallabAccordion-{{ variable.pk }}">
        <div class="accordion-body">
          {% if object.vallab %}
            <p class="mb-2"><strong>Name:</strong> {{ object.vallab.vallabname }}</p>

            {% if vallab_values %}
              <div class="table-responsive small">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr><th style="width:8rem;">Value</th><th>Label</th></tr>
                  </thead>
                  <tbody>
                    {% for it in vallab_values %}
                      <tr>
                        <td>{{ it.value }}</td>
                        <td>{{ it.text }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted mb-0">Dieses Value-Label hat offenbar noch keine Werte.</p>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">Kein Value-Label zugeordnet.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Eigenschaften: bis zu 4 Accordion-Cards, nur aktive Flags -->
  <div class="accordion" id="eigenschaftenAccordion-{{ variable.pk }}">
    {% if flags_active %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingEigenschaften-{{ variable.pk }}">
            <button class="accordion-button" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseEigenschaften-{{ variable.pk }}"
                    aria-expanded="true"
                    aria-controls="collapseEigenschaften-{{ variable.pk }}">
              Eigenschaften
            </button>
          </h2>

          <div id="collapseEigenschaften-{{ variable.pk }}"
              class="accordion-collapse collapse show"
              aria-labelledby="headingEigenschaften-{{ variable.pk }}"
              data-bs-parent="#eigenschaftenAccordion-{{ variable.pk }}">
            <div class="accordion-body">
              <div class="vstack gap-2">
                {% for f in flags_active %}
                  <div id="reason-{{ f.key }}-{{ variable.pk }}" class="card border-0 shadow-sm">
                    <div class="card-body py-2 px-3 d-flex align-items-baseline">
                      <span class="badge text-bg-primary me-3 flex-shrink-0 text-center"
                            style="width: 6rem;">{{ f.label }}</span>
                      <div class="small text-body flex-grow-1">
                        {{ f.reason|default:"Kein Grund hinterlegt."|linebreaksbr }}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              {% if object.comment %}
                <hr class="my-3">
                <div>
                  <strong>Kommentar:</strong><br>
                  <div class="text-body">{{ object.comment|linebreaksbr }}</div>
                </div>
              {% endif %}

            </div>
          </div>
        </div>
    {% else %}
      <p class="text-muted mt-3"></p>
    {% endif %}

  
{% endblock %}
