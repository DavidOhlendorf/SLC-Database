{% extends "main.html" %}

{% block content %}
<div class="container my-4">

  <header class="mb-4">
    <h1 class="display-5 d-flex align-items-center gap-2">{{ object.varname }}</h1>
    <div class="text-muted ">{{ object.varlab }}</div>
  </header>

  <!-- Kontext: Accordion-Card, standardmäßig offen -->
  <div class="accordion mb-3" id="contextAccordion-{{ object.pk }}">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingContext-{{ object.pk }}">
        <button class="accordion-button" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseContext-{{ object.pk }}"
                aria-expanded="true"
                aria-controls="collapseContext-{{ object.pk }}">
          Kontext
        </button>
      </h2>

      <div id="collapseContext-{{ object.pk }}"
           class="accordion-collapse collapse show"
           aria-labelledby="headingContext-{{ object.pk }}"
           data-bs-parent="#contextAccordion-{{ object.pk }}">
        <div class="accordion-body">

          <div class="mb-3">
            <strong class="d-block mb-1">Frage</strong>
            {% if object.question %}
              <div class="card clickable-card border-0 shadow-sm small position-relative">
                <div class="card-body py-2 px-3">
                  <div class="fw-semibold mb-1">
                    {{ object.question.questiontext|truncatechars:160 }}
                  </div>
                  <a href="{% url 'questions:question_detail' object.question.pk %}"
                    class="stretched-link text-decoration-none text-primary">
                  </a>
                </div>
              </div>
            {% else %}
              <span class="text-muted">–</span>
            {% endif %}
          </div>

          <div>
            <strong class="d-block mb-1">Befragungen</strong>
            {% if object.waves.exists %}
              <div class="d-flex flex-wrap gap-2">
                {% for w in object.waves.all %}
                  <span class="badge rounded-pill text-bg-light border">{{ w.name|default:w }}</span>
                {% endfor %}
              </div>
            {% else %}
              <span class="text-muted">Keine Befragungen verknüpft.</span>
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>
  
  <!-- Value-Label: 1 Accordion-Card, standardmäßig offen -->
  <div class="accordion mb-3" id="vallabAccordion-{{ object.pk }}">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingVallab-{{ object.pk }}">
        <button class="accordion-button" type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapseVallab-{{ object.pk }}"
                aria-expanded="true"
                aria-controls="collapseVallab-{{ object.pk }}">
          Value-Label
        </button>
      </h2>
      <div id="collapseVallab-{{ object.pk }}"
           class="accordion-collapse collapse show"
           aria-labelledby="headingVallab-{{ object.pk }}"
           data-bs-parent="#vallabAccordion-{{ object.pk }}">
        <div class="accordion-body">
          {% if object.vallab %}
            <p class="mb-2"><strong>Name:</strong> {{ object.vallab.vallabname }}</p>

            {% if vallab_values %}
              <div class="table-responsive small">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr><th style="width:8rem;">Value</th><th>Label</th></tr>
                  </thead>
                  <tbody>
                    {% for it in vallab_values %}
                      <tr>
                        <td>{{ it.value }}</td>
                        <td>{{ it.text }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted mb-0">Dieses Value-Label hat offenbar noch keine Werte.</p>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">Kein Value-Label zugeordnet.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Eigenschaften: bis zu 4 Accordion-Cards, nur aktive Flags -->
  <div class="accordion" id="eigenschaftenAccordion-{{ object.pk }}">
    {% if flags_active %}
      <div class="accordion mt-3" id="eigenschaftenAccordion-{{ object.pk }}">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingEigenschaften-{{ object.pk }}">
            <button class="accordion-button" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseEigenschaften-{{ object.pk }}"
                    aria-expanded="true"
                    aria-controls="collapseEigenschaften-{{ object.pk }}">
              Eigenschaften
            </button>
          </h2>

          <div id="collapseEigenschaften-{{ object.pk }}"
              class="accordion-collapse collapse show"
              aria-labelledby="headingEigenschaften-{{ object.pk }}"
              data-bs-parent="#eigenschaftenAccordion-{{ object.pk }}">
            <div class="accordion-body">
              <div class="vstack gap-2">
                {% for f in flags_active %}
                  <div id="reason-{{ f.key }}-{{ object.pk }}" class="card border-0 shadow-sm">
                    <div class="card-body py-2 px-3 d-flex align-items-baseline">
                      <span class="badge text-bg-primary me-3 flex-shrink-0 text-center"
                            style="width: 6rem;">{{ f.label }}</span>
                      <div class="small text-body flex-grow-1">
                        {{ f.reason|default:"Kein Grund hinterlegt."|linebreaksbr }}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              {% if object.comment %}
                <hr class="my-3">
                <div>
                  <strong>Kommentar:</strong><br>
                  <div class="text-body">{{ object.comment|linebreaksbr }}</div>
                </div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>
    {% else %}
      <p class="text-muted mt-3"></p>
    {% endif %}

  
{% endblock %}
