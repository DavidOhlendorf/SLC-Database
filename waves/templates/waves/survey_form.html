{% extends "main.html" %}
{% load static %}
{% block extra_js %}
    <script src="{% static 'js/ui/tooltips.js' %}"></script>
    <script src="{% static 'js/builder/wave_formset.js' %}"></script>
{% endblock %}


{% block content %}
    <header class="mb-4">
        <h1>Neue Befragung anlegen</h1>
    </header>

    <form method="post" class="mt-3" style="max-width: 980px;">
        {% csrf_token %}

       <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex align-items-start justify-content-between">
                    <div>
                        <h5 class="card-title mb-1">Befragung / Erhebungsjahr</h5>
                        <div class="text-muted small">Bitte vergib einen eindeutigen Namen, der noch nicht verwendet wird.
                            Im SLC entspricht der Name der Befragung für gewöhnlich dem Erhebungsjahr (z.B. "EJ 2026").
                        </div>
                    </div>

                    <button type="button"
                        class="btn btn-sm"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="Hier legst du die Basisdaten an, unter denen die Befragung gefunden werden kann. Der Name muss eindeutig sein und darf noch nicht genutzt werden. Das Jahr ist optional und dient der Sortierung.">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                </div>

                <div class="row g-3 mt-1">
                    <div class="col-md-7">
                        <div class="form-floating">
                            {{ form.name }}
                            <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        </div>
                            {% if form.name.errors %}
                                <div class="invalid-feedback d-block">{{ form.name.errors|striptags }}</div>
                            {% endif %}
                    </div>

                    <div class="col-md-5">
                        <div class="form-floating">
                            {{ form.year }}
                            <label for="{{ form.year.id_for_label }}">{{ form.year.label }}</label>
                        </div>

                        {% if form.year.errors %}
                            <div class="invalid-feedback d-block">{{ form.year.errors|striptags }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>


        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex align-items-start justify-content-between">
                    <div>
                        <h5 class="card-title mb-1">Befragungsgruppen</h5>
                        <div class="text-muted small">Hier kannst du angeben, welche Personengruppen in der Befragung vorkommen. Mindestens eine Gruppe pro Befragung ist erforderlich.</div>
                    </div>

                    <button type="button"
                        class="btn btn-sm"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="Jede Gruppe, die eine eigene Fragebogenvariante erhält oder im Fragebogen gesondert gefiltert wird, sollte hier aufgelistet sein. Gruppen können auch später noch hinzugefügt werden. ">
                        <i class="fa-solid fa-circle-info"></i>
                    </button>


                </div>

                <hr class="my-3">
                <div id="wave-alert"
                    class="alert alert-warning d-none mb-3"
                    role="alert">
                <span class="js-wave-alert-text"></span>
                </div>

                {{ wave_formset.management_form }}

                <div id="wave-forms" data-formset-prefix="{{ wave_formset.prefix }}" class="vstack gap-3">
                {% for wf in wave_formset %}
                    <div class="wave-form border rounded-3 p-3 bg-body-tertiary">
                        {% if wf.non_field_errors %}
                            <div class="alert alert-warning py-2 mb-2">
                                {{ wf.non_field_errors }}
                            </div>
                        {% endif %}
                        <div class="row g-3 justify-content-center align-items-start">

                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ wf.cycle }}
                                    <label for="{{ wf.cycle.id_for_label }}">{{ wf.cycle.label }}</label>
                                </div>
                                {% if wf.cycle.errors %}
                                    <div class="invalid-feedback d-block">{{ wf.cycle.errors|striptags }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-3">
                                <div class="form-floating">
                                    {{ wf.instrument }}
                                    <label for="{{ wf.instrument.id_for_label }}">{{ wf.instrument.label }}</label>
                                </div>
                                {% if wf.instrument.errors %}
                                    <div class="invalid-feedback d-block">{{ wf.instrument.errors|striptags }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-2">
                                <div class="form-floating">
                                    {{ wf.start_date }}
                                    <label for="{{ wf.start_date.id_for_label }}">{{ wf.start_date.label }}</label>
                                </div>
                                {% if wf.start_date.errors %}
                                    <div class="invalid-feedback d-block">{{ wf.start_date.errors|striptags }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-2">
                                <div class="form-floating">
                                    {{ wf.end_date }}
                                    <label for="{{ wf.end_date.id_for_label }}">{{ wf.end_date.label }}</label>
                                </div>
                                {% if wf.end_date.errors %}
                                    <div class="invalid-feedback d-block">{{ wf.end_date.errors|striptags }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-1 text-end">
                                <div class="d-none">
                                    {{ wf.DELETE }}
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm js-remove-wave"
                                        title="Gruppe entfernen">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>

                        </div>
                    </div>
                {% endfor %}
                </div>

                <template id="empty-wave-form">
                <div class="wave-form border rounded-3 p-3 bg-body-tertiary">
                   <div class="row g-3 justify-content-center align-items-start">

                        <div class="col-md-4">
                            <div class="form-floating">
                                {{ wave_formset.empty_form.cycle }}
                                <label for="{{ wave_formset.empty_form.cycle.id_for_label }}">{{ wave_formset.empty_form.cycle.label }}</label>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-floating">
                                {{ wave_formset.empty_form.instrument}}
                                <label for="{{ wave_formset.empty_form.instrument.id_for_label }}">{{ wave_formset.empty_form.instrument.label }}</label>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <div class="form-floating">
                                {{ wave_formset.empty_form.start_date }}
                                <label for="{{ wave_formset.empty_form.start_date.id_for_label }}">{{ wave_formset.empty_form.start_date.label }}</label>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <div class="form-floating">
                                {{ wave_formset.empty_form.end_date }}
                                <label for="{{ wave_formset.empty_form.end_date.id_for_label }}">{{ wave_formset.empty_form.end_date.label }}</label>
                            </div>
                        </div>

                        <div class="col-md-1 text-end">
                            <div class="d-none">
                                {{ wave_formset.empty_form.DELETE }}
                            </div>
                            <button type="button" class="btn btn-outline-danger btn-sm js-remove-wave">
                            <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>

                    </div>
                </div>
                </template>

                <button type="button" class="btn btn-outline-dark btn-sm mt-3" id="add-wave">
                    + Neue Gruppe
                </button>
            </div>
        </div>

        <div class="d-flex gap-2">
        <button type="submit" class="btn btn-dark">Speichern</button>
        <a href="{% url 'waves:survey_list' %}" class="btn btn-outline-secondary">Abbrechen</a>
        </div>
    </form>

{% endblock %}
